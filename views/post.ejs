<%- include('partials/header') -%>
<main class="main-grid-container">
  <%- include('partials/nav') -%>
  <section class="grid-item">
    <h1>Speck</h1>
    <div class="post">
      <h2 data-id="<%= post._id %>"><%= post.title %></h2>
      <p class="post-content"><%= post.content %></p>
      <!-- If image exists, show image -->
      <% if(post.image) { %>
      <div class="image-container">
        <img class="post-image" src="<%= post.image%>" alt="image" />
      </div>
      <% } %>
      <p>
        By <span class="author"><%= post.author %></span> - <%= post.createdAt ?
        post.createdAt.toDateString() : 'Unknown Date' %>
      </p>

      <div class="edit-del-btns">
        <% if(user && String(post.userId) === user.id) { %>

        <a class="submit-btns" href="/posts/edit/<%= post._id %>">Edit</a>

        <% } %> <% if(user && String(post.userId) === user.id) { %>
        <form action="/posts/<%= post._id %>?_method=DELETE" method="POST">
          <button class="delete-btns" type="submit">Delete</button>
        </form>
        <% } %>
      </div>
    </div>
    <!-- Lightbox modal -->
    <div
      id="lightbox"
      class="lightbox hidden"
      role="dialog"
      aria-modal="true"
      aria-label="Image viewer"
      tabindex="-1">
      <button class="lightbox__close" aria-label="Close">&times;</button>
      <img id="lightbox-image" alt="" />
    </div>

    <!-- COMMENTS SECTION -->
    <h3>Comments</h3>
    <section class="comments-sec">
      <form class="comment-form" action="/comment/createComment" method="POST">
        <input type="hidden" name="postId" value="<%= post._id %>" />
        <img
          class="comment-avatar"
          src="<%= (user && user.avatarUrl) ? user.avatarUrl : '/images/default-avatar.png' %>"
          alt="<%= (user && user.name) ? user.name : 'User' %>"
          onerror="this.src='/images/default-avatar.png'" />

        <div class="comment-composer">
          <textarea
            class="comment-textarea"
            name="content"
            id="content"
            rows="1"
            placeholder="Share your thoughts..."
            required
            aria-label="Write a comment"></textarea>

          <div class="comment-actions">
            <button class="post-btn" type="submit" disabled>Post</button>
          </div>
        </div>
      </form>

      <% const _comments = (typeof comments !== 'undefined' &&
      Array.isArray(comments)) ? comments : []; %>
      <ul class="comment-list">
        <% if (_comments.length === 0) { %>
        <li class="comment-empty">Be the first to comment.</li>
        <% } %> <% _comments.forEach(c => { %>
        <li class="comment-item" id="comment-<%= c._id %>">
          <img
            class="comment-avatar"
            src="<%= c.userId?.avatarUrl || '/images/default-avatar.png' %>"
            alt="<%= c.userId?.userName || 'User' %>" />
          <div class="comment-body">
            <div class="comment-meta">
              <span class="comment-author"
                ><%= c.userId?.userName || 'User' %></span
              >
              <span class="comment-time"
                ><%= new Date(c.createdAt).toLocaleString() %></span
              >
            </div>
            <p class="comment-text"><%= c.content %></p>

            <!-- Delete comment button -->
            <% if (user && c.userId && String(c.userId._id) === String(user.id))
            { %>
            <div class="comment-menu">
              <button
                class="menu-btn"
                aria-haspopup="true"
                aria-expanded="false"
                title="More">
                ⋮
              </button>
              <div class="menu" hidden>
                <form
                  method="POST"
                  action="/comment/<%= c._id %>?_method=DELETE">
                  <button type="submit" class="menu-delete">Delete</button>
                </form>
              </div>
            </div>
            <% } %>
          </div>
        </li>
        <% }) %>
      </ul>
    </section>

    <a class="submit-btns" href="/posts">Back to Posts</a>
  </section>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-image");
    const closeBtn = document.querySelector(".lightbox__close");

    // Open when clicking any post image
    document.querySelectorAll(".post-image").forEach((img) => {
      img.addEventListener("click", () => {
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt || "";
        lightbox.classList.remove("hidden");
        document.body.style.overflow = "hidden"; // prevent background scroll
        lightbox.focus();
      });
    });

    const closeLightbox = () => {
      lightbox.classList.add("hidden");
      lightboxImg.src = "";
      document.body.style.overflow = "";
    };

    // Close on X button
    closeBtn.addEventListener("click", closeLightbox);

    // Close when clicking the overlay (but not the image)
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // Close on Escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
        closeLightbox();
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector(".comment-form");
    if (!form) return;

    const textarea = form.querySelector(".comment-textarea");
    const postBtn = form.querySelector(".post-btn");
    if (!textarea || !postBtn) return;

    function autoResize(el) {
      // Reset height so scrollHeight is accurate
      el.style.height = "0px";
      el.style.height = el.scrollHeight + "px";
    }

    function updateState() {
      const hasText = textarea.value.trim().length > 0;
      postBtn.disabled = !hasText;
    }

    // Init
    textarea.setAttribute("rows", "1");
    autoResize(textarea);
    updateState();

    // Events: cover typing, paste, drag-drop
    ["input", "change"].forEach((evt) =>
      textarea.addEventListener(evt, () => {
        autoResize(textarea);
        updateState();
      })
    );

    // Optional: Cmd/Ctrl + Enter to submit
    textarea.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && !postBtn.disabled) {
        form.submit();
      }
    });
  });
</script>

<!-- 3 dot menu button to delete comment -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Open/close the small menu
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".menu-btn");
      const allMenus = document.querySelectorAll(".comment-menu .menu");

      if (btn) {
        const wrap = btn.closest(".comment-menu");
        const menu = wrap.querySelector(".menu");
        allMenus.forEach((m) => {
          if (m !== menu) m.hidden = true;
        });
        menu.hidden = !menu.hidden;
        btn.setAttribute("aria-expanded", String(!menu.hidden));
        return;
      }

      // Clicked outside any menu → close all
      if (!e.target.closest(".comment-menu")) {
        allMenus.forEach((m) => (m.hidden = true));
        document
          .querySelectorAll(".menu-btn[aria-expanded='true']")
          .forEach((b) => b.setAttribute("aria-expanded", "false"));
      }
    });

    // Close on Escape
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      document
        .querySelectorAll(".comment-menu .menu")
        .forEach((m) => (m.hidden = true));
      document
        .querySelectorAll(".menu-btn[aria-expanded='true']")
        .forEach((b) => b.setAttribute("aria-expanded", "false"));
    });
  });
</script>

<%- include('partials/footer') -%>
